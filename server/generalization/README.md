## 接口定义

### 1.   geneTrajs 模糊轨迹

#### 1.1 接口说明

轨迹的 generalizaiton 和 k-anonymity 的处理，步骤如下：

 	1.  预处理
      - 区域裁剪
      - 按照 时间、距离 等对轨迹中的轨迹点进行处理
 	2.  Point Clustering
 	3.  Generation voronois ( using  cluster centroid )
 	4.  Trajectory Segmentation
 	5.  Anonymity  ( KamRec )
 	6.  Statics

#### 1.2 请求参数

| 请求参数     | 类型   | 必填        | 参数说明                              |
| :----------- | ------ | ----------- | ------------------------------------- |
| **trajs**    | Array  | True        |                                       |
| **params**   | Object |             |                                       |
| - k          | Int    | 默认值 5    | k-anonymity 部分的 K 值               |
| -  maxRadius | Float  | 默认值 0.05 | 聚类半径，单位 km                     |
| -  bounds    | Array  |             | bbox                                  |
| -  p         | Float  |             | k-anonymity 部分的 percentage , 0 ~ 1 |

##### JSON 示例

```json
{
  trajs : [
    [
      {"time":"2007-02-20 04:23:40","lng":121.42673120346423,"lat":31.11810022344551},  			{"time":"2007-02-20 04:57:54","lng":121.41623954981362,"lat":31.1194077326937},
      ...
    ],
    ...
  ],
  params: {
     "k":3,
     "p":0.6,
     "maxRadius":1,
     "bounds":[
        [121.3046380719896,31.328184453845363],
        [121.76499465276387,31.328184453845363],
        [121.76499465276387,31.089438912857887],
        [121.3046380719896,31.089438912857887],
        [121.3046380719896,31.328184453845363]
     ]
	}
}
```

#### 1.3 返回参数

| 返回参数        | 类型  | 参数说明                                                     |
| --------------- | ----- | ------------------------------------------------------------ |
| voronois        | Array | 生成的区域 ，在前端可通过 `polygon` 字段绘 ， 每个区域带有唯一 `id` 字段 |
| voronoisStatics | Array | 每个区域的统计值                                             |
| anonyTrajs      | Array | 经过 k-anonymity 处理后的轨迹， `support`  表示相同轨迹的条数 |
| vectors         | Array | 轨迹在区域间的流通情况 ， 通过 `anonyTrajs` 获得             |

##### JSON 示例 

```json
{
  "voronois": [
    {
      "polygon": [
        { "lng": 121.4302711723419, "lat": 31.11660802878807 },
        { "lng": 121.42931941573198, "lat": 31.12599043546592 },
        { "lng": 121.42765424987289, "lat": 31.128226356057503 },
        { "lng": 121.41507140557057, "lat": 31.12525624804026 },
        { "lng": 121.41324428919219, "lat": 31.11660802878807 },
        { "lng": 121.4302711723419, "lat": 31.11660802878807  }
      ],
      "id": 0,
      "centroid": {
        "lng": 121.42148537663893,
        "lat": 31.120402430960524
      }
    },
    ...
  ],
  "voronoisStatics": [
    {
      "id": 0,
      "in": 1,
      "out": 2,
      "sumDist": 3.7958108801430193,
      "meanDist": 0.4744763600178774
    },
    ...
  ],
  "anonyTrajs": [
    {
      "points": [
        {
          "lng": 121.48190720487196,
          "lat": 31.18642731042666
        },
        {
          "lng": 121.42148537663893,
          "lat": 31.4302711723419
        },
        {
          "lng": 121.48066145801869,
          "lat": 31.197125628776817
        }
      ],
      "support": 1
    },
    ...
  ],
  "vectors": [
    {
      "from": 4,
      "to": 5,
      "support": 1,
      "fromPoint": {
        "lng": 121.48190720487196,
        "lat": 31.18642731042666
      },
      "toPoint": {
        "lng": 121.48066145801869,
        "lat": 31.197125628776817
      }
    },
    ...
  ]
}
```



### 2.   genePoints 模糊坐标点

#### 2.1 接口说明

对一系列坐标点进行聚类处理

#### 2.2 请求参数

| 请求参数       | 类型   | 必填        | 参数说明                                           |
| :------------- | ------ | ----------- | -------------------------------------------------- |
| **points**     | Array  | True        |                                                    |
| **params**     | Object |             |                                                    |
| -  k           | Int    | 默认值 5    | 一个聚类中点的最小个数，小于该值的点（区域）被舍去 |
| -  innerRaduis | Float  | 默认值 0.05 | 聚类半径，单位 km                                  |
| - outerRadius  | Float  | 默认值 0.05 | 区域合并时的 stopRadius                            |

##### JSON 示例

```json
{
  points : [
    { lng: 120.6462979, lat: 28.00516276 },
    { lng: 120.318047, lat: 27.635101 },
    { lng: 120.403912, lat: 27.519487 },
    ...
  ],
  params: {
     "k":3,
     "maxRadius":1,
	}
}
```

#### 2.3 返回参数

| 返回参数 | 参数说明   | 类型  |
| -------- | ---------- | ----- |
| groups   | 生成的聚类 | Array |

##### JSON 示例 

```json
{
  groups : [
      {
        "members": [
          {
            "lng": 120.6462979,
            "lat": 28.00516276,
            "groupId": 0,
            "toCentroidDist": 0.5775012162357103
          },
          {
            "lng": 120.636414,
            "lat": 28.005124,
            "groupId": 0,
            "toCentroidDist": 0.3962423641294484
          },
          ...
        ],
        "id": 0,
        "centroid": {
          "belongsGroupId": 0,
          "p": {
            "lng": 120.64043140000001,
            "lat": 28.0047815
          }
        }
      },
      ...
	]
}
```



---



## 文件介绍

##### ~~1.  `characteristic.js`   (弃用)~~

将一条轨迹(由许多个轨迹点组成)通过几个有**代表性**的点来表示

可调节的参数：（**当前是写死的**）`minAngle`、 `minStopDuration   `、  `minDistance`  、`maxDistance`

##### 2.  `cluster.js`

点聚类。确定 **矩形边界**，将矩形划分成 grid 用作索引，随后构造 groups。

可调节的参数：

- `maxRadius` ： 0.05
- `k`  ： minimum number of elements in class

##### 3   `partition.js` 

划分区域。按照 `groups` 中每个 group 的**中心点(centroid)**进行  Voronoi 区域划分

#####  4  `segment.js`

将轨迹点代入区域，进行分段。遍历每条轨迹，将原轨迹点序列表示为 Voronoi 区域 id 的序列

##### ~~5  Progressive Generalization （弃用）~~

---有些区域可能包含的轨迹数小于 K ，因此通过**迭代地合并**这些区域的方式消除因此问题。

合并后形成新的 **voronoi 区域** 和 **轨迹序列**

可调节的参数：

- k  
- step 迭代次数 （ 达到该次数自动停止）
- leastVoronoiNum  最少合并区域数量（当合并后的区域小于该次数自动停止）

##### 5. `join.js`

将地理区域进行合并。

##### 6. `anonymity.js`

将前面形成的**轨迹序列**导入，构造**前缀树**。每个节点中的 `support` 代表经过当前节点的轨迹次数。

Tree Prune 阶段： 若子树的 support 值小于 K ，则剪枝，父节点 support 减去对应值，并将子树中的**轨迹**（从头开始的） 加入 Recovery 队列

Tree Recovery 阶段：比较队列中的轨迹 与 **树** 或 **队列 中**的轨迹的 **最长公共子串**（连续的），并比较得到的子串与原序列的**比值** ，若大于 P ，则从头加入到树中

可调节的参数：

- `p`  :  0.5  
- `k` ：5x



-----



## 单元测试

最好对每个模块进行输入输出的测试，不过测试用例如何设计是个问题 : ）

通过   `jest 目标路径/`   运行

## 数据

#### 1. 轨迹数据

##### 1.1 处理流程:

 	1. 源 txt
 	2. python粗处理导出csv
 	3.  js 预处理

##### 1.2 注意点

当前地图使用 **WGS84** 格式

按照 **计算速度** 和 **精细度** 要求选择**数据量**大小

#### 2. 微博点数据

...



## 实现前后端通用
```
npm run eject 弹出 webpack 配置
```
将 webpack.config.dev 中 ModuleScopePlugin命令注释掉
这样可以在前端代码中直接 require 当前模块的代码

